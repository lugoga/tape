---
title: "Untitled"
format: html
---

# Introduction
```{r}
require(tidyverse)
require(terra)
require(tidyterra)
require(ggspatial)
require(magrittr)
require(sf)
require(leaflet)
require(leaflet.extras)
require(htmlwidgets)
```


# Method
## Layers

```{r}
mab = st_read('Data/spatial/tanga_pemba_biosphere_extent.gpkg')
mab  = mab  |> 
    mutate(area_m = st_area(geometry),
           area_km = as.numeric(area_m) / 1e6,
           area_ha = area_km * 100        
) 


cfmas = st_read('Data/spatial/cfmas.gpkg') |> 
    # st_make_valid() |> 
    st_sf()
islands = st_read('Data/spatial/baseline/islands.gpkg') |> 
    st_make_valid()
aoi = st_read('Data/spatial/tanga_pemba_biosphere_extent.gpkg')

aoi =aoi |> 
    st_transform(32737) |> 
    mutate(area_m = st_area(geometry),
           area_km = as.numeric(area_m) / 1e6,
           area_ha = area_km * 100        
    ) |> 
    st_transform(4326)


islands_aoi = islands |> 
    st_intersection(aoi)

mma = st_read('Data/spatial/mma.gpkg') |> janitor::clean_names()
```


```{r}
islands_aoi = islands_aoi |> 
    select(name = NAME) |> 
    mutate(area_m = st_area(geom),
           area_km = as.numeric(area_m) / 1e6,
           area_ha = area_km * 100        
    ) |> 
    select(-area_m) |> 
    filter(!name == 'Pemba Island') 

zones = islands_aoi  |> 
    st_transform(32737) |> 
    st_buffer(dist = c(2000)) |> 
    st_union() |> 
    st_sf() |> 
    st_transform(4326)


```


```{r}

tape = leaflet() |> 
    setView(lng = 39.5, lat = -5.2, zoom = 10) |>
    addProviderTiles(providers$Esri.WorldImagery, group = "ESRI Imagery") |>
    addProviderTiles(providers$Esri.OceanBasemap, group = "Ocean Basemap") |>
    addProviderTiles(providers$OpenTopoMap, group = "Topographic") |>
    addTiles(group = "OpenStreetMap") |>
    addPolygons(data = mab, group = 'Hifadhi Hai',
                fillColor = 'blue', color = 'black', 
                weight = 2,     
                fillOpacity = 0.1, opacity = 1, 
                label = ~htmltools::htmlEscape(name), 
                popup = ~paste0("<strong>Name: </strong>", name, 
                                # "<br><strong>Class: </strong>", class,
                                "<br><strong>Area (ha): </strong>", scales::comma(area_ha),
                                "<br><strong>Area (km): </strong>",  scales::comma(area_km)
                            ),
                labelOptions = labelOptions(noHide = F, direction = 'auto')
            ) |>
    addPolygons(data = mma, group = 'MPA/MCA',
                fillColor = 'blue', color = 'blue', 
                weight = 2,     
                fillOpacity = 0.5, opacity = 1, 
                label = ~htmltools::htmlEscape(name), 
                popup = ~paste0("<strong>Name: </strong>", name, 
                                "<br><strong>Class: </strong>", class,
                                "<br><strong>Area (ha): </strong>", round(mma_area_h, 2)),
                labelOptions = labelOptions(noHide = F, direction = 'auto')
            ) |>
    addPolygons(data = cfmas, group = 'Eneo Mpito',
                fillColor = 'red', color = 'red', # Fill and stroke color
                weight = 2,      # Stroke width
                fillOpacity = 0.5, opacity = 1, 
                label = ~htmltools::htmlEscape(name)
            ) |>
    addPolygons(data = islands_aoi, group = 'Eneo Msingi',
                fillColor = 'darkgreen', color = 'darkgreen',
                weight = 2, fillOpacity = 0.5, opacity = 1, 
                label = ~htmltools::htmlEscape(name), 
                popup = ~paste0("<strong>Name: </strong>", name, 
                                # "<br><strong>Class: </strong>", class,
                                "<br><strong>Area (ha): </strong>", round(area_ha, 2)),
                labelOptions = labelOptions(noHide = F, direction = 'auto')
            ) |>
    addPolygons(data = zones, group = 'Eneo Kinga',
                fillColor = 'yellow', color = 'orange',
                weight = 2, fillOpacity = 0.5, opacity = 1
            ) |>
    addLayersControl(
        baseGroups = c("OpenStreetMap", "ESRI Imagery", "Ocean Basemap", "Topographic"),
        # overlayGroups = c('Eneo Msingi', 'Eneo Kinga', 'Eneo Mpito', 'Hifadhi Hai', 'MPA/MCA', 'Drawn Items', 'Graticule'),
        position = "bottomright",
        options = layersControlOptions(collapsed = FALSE)
    ) |>
    addLayersControl(
        # baseGroups = c("OpenStreetMap", "ESRI Imagery", "Ocean Basemap", "Topographic"),
        overlayGroups = c('Eneo Msingi', 'Eneo Kinga', 'Eneo Mpito', 'Hifadhi Hai', 'MPA/MCA', 'Drawn Items', 'Graticule'),
        position = "topright",
        options = layersControlOptions(collapsed = FALSE)
    ) |>  
        hideGroup(group = c('Hifadhi Hai', 'MPA/MCA', 'Drawn Items', 'Graticule'))|>
    # Legend for the filled polygons
    addLegend(
        position = "bottomright",
        colors = c("blue", "yellow", "red", "green"),
        labels = c("Eneo Kinga", "Eneo Mpito","Eneo Msingi",  "MPA/MCA"),
        title = "Legend",
        opacity = 1
    ) |>
    # Add a separate legend for the TAPE outline
    addLegend(
        position = "bottomright",
        colors = "black",
        labels = "TAPE Biosphere Extent",
        opacity = 1
    ) |>
    addMiniMap(
        # tiles = providers$Esri.OceanBasemap,
        toggleDisplay = TRUE, 
        position = 'bottomleft',
        minimized = FALSE
    ) |>
    addScaleBar(position = "bottomleft") |> 
    addFullscreenControl() |> 
    addDrawToolbar(
        targetGroup = 'Drawn Items',
        editOptions = editToolbarOptions(
            selectedPathOptions = selectedPathOptions()
        ),
        polylineOptions = FALSE, circleOptions = FALSE, rectangleOptions = TRUE, markerOptions = TRUE, circleMarkerOptions = FALSE
    ) |> 
    addMeasure(
        position = "topleft",
        primaryLengthUnit = "meters", secondaryLengthUnit = "kilometers",
        primaryAreaUnit = "square meters", secondaryAreaUnit = "hectares",
        activeColor = "#3D535D",
        completedColor = "#7D4479") |> 
    addGraticule(
        interval = 0.2,
        style = list(color = "#333", weight = 0.8, opacity = 0.5),
        group = "Graticule",
        options = pathOptions(pointerEvents = "none", clickable = FALSE)
    ) 


tape
# tape |> 
#     htmlwidgets::saveWidget(file = 'index.html')


``` 


```{r}

```